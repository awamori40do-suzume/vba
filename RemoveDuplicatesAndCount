Sub RemoveDuplicatesAndCountFromTestWorkbook()
    Dim ws As Worksheet
    Dim testWorkbook As Workbook
    Dim testFilePath As String
    Dim lastRowA As Long, lastRowI As Long
    Dim i As Long, rowIndex As Long
    Dim uniqueDict As Object
    Dim key As Variant
    Dim items() As String
    Dim item As Variant
    Dim totalRow As Long
    
    ' 現在のブックのシートを設定
    Set ws = ThisWorkbook.Sheets(1)
    
    ' 同じディレクトリにあるテスト.xslmファイルのパスを取得
    testFilePath = ThisWorkbook.Path & "\テスト.xslm"
    
    ' テスト.xslmを開く
    On Error Resume Next
    Set testWorkbook = Workbooks.Open(testFilePath)
    On Error GoTo 0
    
    If testWorkbook Is Nothing Then
        MsgBox "テスト.xslmファイルが見つかりません。", vbExclamation
        Exit Sub
    End If
    
    ' テスト.xslmのシート1を取得
    Dim testWs As Worksheet
    Set testWs = testWorkbook.Sheets(1)
    
    ' テスト.xslmのA列の最終行を取得
    lastRowA = testWs.Cells(testWs.Rows.Count, 1).End(xlUp).Row
    
    ' Dictionaryオブジェクトを作成
    Set uniqueDict = CreateObject("Scripting.Dictionary")
    
    ' テスト.xslmのA列のデータを走査し、カンマで区切って個別にカウント
    For i = 1 To lastRowA
        ' A列のセルの値をカンマで分割
        items = Split(testWs.Cells(i, 1).Value, ",")
        
        ' 分割した各項目を走査してカウント
        For Each item In items
            item = Trim(item) ' 余分なスペースを削除
            If item <> "" Then
                If Not uniqueDict.Exists(item) Then
                    uniqueDict.Add item, 1 ' 初めての値を追加
                Else
                    uniqueDict(item) = uniqueDict(item) + 1 ' カウントを増加
                End If
            End If
        Next item
    Next i
    
    ' テスト.xslmを閉じる
    testWorkbook.Close False
    
    ' I列で「合計」を探す
    totalRow = ws.Columns(9).Find(What:="合計", LookIn:=xlValues, LookAt:=xlWhole).Row
    
    If totalRow = 0 Then
        MsgBox "I列に「合計」が見つかりません。", vbExclamation
        Exit Sub
    End If
    
    ' I列の最終行を「合計」の直前に設定
    lastRowI = totalRow - 1
    
    ' B列とC列にデータを書き込み
    rowIndex = 1
    For Each key In uniqueDict.Keys
        ws.Cells(rowIndex, 2).Value = key ' B列に値を転記
        ws.Cells(rowIndex, 3).Value = uniqueDict(key) ' C列にカウントを転記
        rowIndex = rowIndex + 1
    Next key
    
    ' I列に存在するデータに対応してカウントをJ列に書き込み
    For i = 1 To lastRowI
        key = ws.Cells(i, 9).Value ' I列の値
        If uniqueDict.Exists(key) Then
            ws.Cells(i, 10).Value = uniqueDict(key) ' J列にカウントを書き込み
            uniqueDict.Remove key ' カウント済みのデータは削除
        Else
            ws.Cells(i, 10).Value = 0 ' B列に存在しない場合はカウントを0とする
        End If
    Next i
    
    ' I列に存在しないB列の品目を「合計」の上に追加
    rowIndex = totalRow ' 「合計」の位置を基準にする
    For Each key In uniqueDict.Keys
        ' セルの挿入 (「合計」の上に新しい行を追加)
        ws.Rows(rowIndex).Insert Shift:=xlDown
        ws.Cells(rowIndex, 9).Value = key ' I列に値を追加
        ws.Cells(rowIndex, 10).Value = uniqueDict(key) ' その横にカウントを追加
        rowIndex = rowIndex + 1
    Next key
End Sub
